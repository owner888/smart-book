# Smart Book AI Server

[![Latest Version on Packagist](https://img.shields.io/packagist/v/owner888/smart-book.svg?style=flat-square)](https://packagist.org/packages/owner888/smart-book)
[![License](https://img.shields.io/packagist/l/owner888/smart-book.svg?style=flat-square)](https://packagist.org/packages/owner888/smart-book)
[![PHP Version](https://img.shields.io/packagist/php-v/owner888/smart-book.svg?style=flat-square)](https://packagist.org/packages/owner888/smart-book)

åŸºäº Workerman çš„æ™ºèƒ½ä¹¦ç±é—®ç­”æœåŠ¡ï¼Œæ”¯æŒ RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ã€‚

## å®‰è£…

### é€šè¿‡ Composer å®‰è£…

```bash
composer require owner888/smart-book
```

### æ‰‹åŠ¨å®‰è£…

```bash
git clone https://github.com/owner888/smart-book.git
cd smart-book
composer install
```

## åŠŸèƒ½ç‰¹æ€§

- ğŸ“š **RAG é—®ç­”** - åŸºäºä¹¦ç±å†…å®¹çš„æ™ºèƒ½é—®ç­”
- ğŸ” **æ··åˆæ£€ç´¢** - å…³é”®è¯ + å‘é‡åŒé‡æ£€ç´¢
- ğŸ’¬ **æµå¼å“åº”** - æ”¯æŒ SSE å’Œ WebSocket å®æ—¶æµå¼è¾“å‡º
- ğŸš€ **é«˜æ€§èƒ½** - åŸºäº Workerman å¼‚æ­¥æ¶æ„
- ğŸ’¾ **æ™ºèƒ½ç¼“å­˜** - Redis ç¼“å­˜ + è¯­ä¹‰ç›¸ä¼¼åº¦åŒ¹é…

## å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

```bash
composer install
```

### 2. é…ç½®ç¯å¢ƒ

```bash
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå¡«å…¥ GEMINI_API_KEY
```

### 3. å¯åŠ¨æœåŠ¡

```bash
php server.php start          # å‰å°è¿è¡Œ
php server.php start -d       # åå°è¿è¡Œ
php server.php stop           # åœæ­¢
php server.php restart        # é‡å¯
php server.php status         # çŠ¶æ€
```

### 4. è®¿é—®

- Web ç•Œé¢: http://localhost:8088
- API: http://localhost:8088/api
- WebSocket: ws://localhost:8081
- MCP Server: http://localhost:8089/mcp

## ç›®å½•ç»“æ„

```
smart-book/
â”œâ”€â”€ config/                     # é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ app.php                 # åº”ç”¨é…ç½®ï¼ˆç«¯å£ã€AIã€ä¹¦ç±è·¯å¾„ï¼‰
â”‚   â”œâ”€â”€ database.php            # æ•°æ®åº“/Redis é…ç½®
â”‚   â””â”€â”€ prompts.php             # AI æç¤ºè¯é…ç½®
â”‚
â”œâ”€â”€ src/                        # æºä»£ç 
â”‚   â”œâ”€â”€ AI/                     # AI å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ GeminiClient.php    # Gemini API åŒæ­¥å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ AsyncGeminiClient.php # Gemini API å¼‚æ­¥å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ AsyncCurlManager.php  # curl_multi å¼‚æ­¥ç®¡ç†å™¨
â”‚   â”‚   â””â”€â”€ AIService.php       # AI æœåŠ¡ç»Ÿä¸€ç®¡ç†
â”‚   â”‚
â”‚   â”œâ”€â”€ Cache/                  # ç¼“å­˜æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ CacheService.php    # Redis ç¼“å­˜ï¼ˆé—®ç­”/è¯­ä¹‰ç´¢å¼•ï¼‰
â”‚   â”‚   â””â”€â”€ RedisVectorStore.php # Redis 8.0 å‘é‡å­˜å‚¨
â”‚   â”‚
â”‚   â”œâ”€â”€ RAG/                    # RAG ç³»ç»Ÿ
â”‚   â”‚   â”œâ”€â”€ EmbeddingClient.php # å‘é‡åµŒå…¥å®¢æˆ·ç«¯
â”‚   â”‚   â”œâ”€â”€ VectorStore.php     # æœ¬åœ°å‘é‡å­˜å‚¨
â”‚   â”‚   â”œâ”€â”€ DocumentChunker.php # æ–‡æ¡£åˆ†å—å™¨
â”‚   â”‚   â””â”€â”€ BookRAGAssistant.php # RAG ä¹¦ç±åŠ©æ‰‹
â”‚   â”‚
â”‚   â”œâ”€â”€ Parser/                 # æ–‡æ¡£è§£æå™¨
â”‚   â”‚   â””â”€â”€ EpubParser.php      # EPUB è§£æå™¨
â”‚   â”‚
â”‚   â””â”€â”€ Http/                   # HTTP å¤„ç†
â”‚       â””â”€â”€ Handlers.php        # è¯·æ±‚å¤„ç†å‡½æ•°
â”‚
â”œâ”€â”€ static/                     # é™æ€èµ„æº
â”‚   â”œâ”€â”€ css/main.css
â”‚   â””â”€â”€ js/main.js
â”‚
â”œâ”€â”€ tests/                      # æµ‹è¯•æ–‡ä»¶
â”‚   â”œâ”€â”€ test_ai.php
â”‚   â”œâ”€â”€ test_rag.php
â”‚   â””â”€â”€ ...
â”‚
â”œâ”€â”€ bootstrap.php               # åˆå§‹åŒ–/è‡ªåŠ¨åŠ è½½
â”œâ”€â”€ server.php                  # æœåŠ¡å…¥å£
â”œâ”€â”€ chat.html                   # Web èŠå¤©ç•Œé¢
â”œâ”€â”€ .env.example                # ç¯å¢ƒå˜é‡æ¨¡æ¿
â””â”€â”€ composer.json               # ä¾èµ–é…ç½®
```

## API æ¥å£

### HTTP API

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/health` | GET | å¥åº·æ£€æŸ¥ |
| `/api/ask` | POST | RAG é—®ç­”ï¼ˆéæµå¼ï¼‰ |
| `/api/chat` | POST | é€šç”¨èŠå¤©ï¼ˆéæµå¼ï¼‰ |
| `/api/stream/ask` | POST | RAG é—®ç­”ï¼ˆSSE æµå¼ï¼‰ |
| `/api/stream/chat` | POST | é€šç”¨èŠå¤©ï¼ˆSSE æµå¼ï¼‰ |
| `/api/cache/stats` | GET | ç¼“å­˜ç»Ÿè®¡ |

### WebSocket API

è¿æ¥ `ws://localhost:8081`ï¼Œå‘é€ JSONï¼š

```json
{"action": "ask", "question": "å­™æ‚Ÿç©ºçš„å¸ˆçˆ¶æ˜¯è°ï¼Ÿ"}
{"action": "chat", "messages": [{"role": "user", "content": "ä½ å¥½"}]}
```

### MCP Server API (Streamable HTTP)

MCP Server è¿è¡Œåœ¨ç«¯å£ 8089ï¼Œå®ç° [MCP 2025-11-25 Streamable HTTP Transport](https://modelcontextprotocol.io/specification/2025-11-25/basic/transports) åè®®ã€‚

**ç«¯ç‚¹ï¼š** `http://localhost:8089/mcp`

| æ–¹æ³• | è¯´æ˜ |
|------|------|
| `GET` | è·å–æœåŠ¡å™¨ä¿¡æ¯å’Œèƒ½åŠ› |
| `POST` | JSON-RPC è¯·æ±‚ï¼ˆæ”¯æŒæ‰¹é‡ï¼‰ |
| `DELETE` | ç»ˆæ­¢ä¼šè¯ |

**ä¼šè¯ç®¡ç†ï¼š**
- æœåŠ¡å™¨é€šè¿‡ `Mcp-Session-Id` HTTP Header ç®¡ç†ä¼šè¯
- `initialize` è¯·æ±‚ä¼šåˆ›å»ºæ–°ä¼šè¯å¹¶è¿”å› Session ID
- åç»­è¯·æ±‚åº”æºå¸¦ Session ID ä»¥ä¿æŒçŠ¶æ€

**JSON-RPC è¯·æ±‚ç¤ºä¾‹ï¼š**

```bash
# 1. åˆå§‹åŒ–ä¼šè¯
curl -X POST http://localhost:8089/mcp \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc":"2.0","method":"initialize","params":{"protocolVersion":"2024-11-05","clientInfo":{"name":"test","version":"1.0"}},"id":1}'

# 2. è·å–å·¥å…·åˆ—è¡¨
curl -X POST http://localhost:8089/mcp \
  -H "Content-Type: application/json" \
  -H "Mcp-Session-Id: <session_id>" \
  -d '{"jsonrpc":"2.0","method":"tools/list","id":2}'

# 3. è°ƒç”¨å·¥å…· - åˆ—å‡ºä¹¦ç±
curl -X POST http://localhost:8089/mcp \
  -H "Content-Type: application/json" \
  -H "Mcp-Session-Id: <session_id>" \
  -d '{"jsonrpc":"2.0","method":"tools/call","params":{"name":"list_books","arguments":{}},"id":3}'

# 4. è°ƒç”¨å·¥å…· - æœç´¢ä¹¦ç±
curl -X POST http://localhost:8089/mcp \
  -H "Content-Type: application/json" \
  -H "Mcp-Session-Id: <session_id>" \
  -d '{"jsonrpc":"2.0","method":"tools/call","params":{"name":"search_book","arguments":{"query":"å­™æ‚Ÿç©º"}},"id":4}'
```

**å¯ç”¨å·¥å…·ï¼š**

| å·¥å…·å | è¯´æ˜ | å‚æ•° |
|--------|------|------|
| `list_books` | åˆ—å‡ºæ‰€æœ‰å¯ç”¨ä¹¦ç± | æ—  |
| `get_book_info` | è·å–å½“å‰ä¹¦ç±ä¿¡æ¯ | æ—  |
| `select_book` | é€‰æ‹©è¦ä½¿ç”¨çš„ä¹¦ç± | `book`: ä¹¦ç±æ–‡ä»¶å |
| `search_book` | åœ¨ä¹¦ç±ä¸­æœç´¢å†…å®¹ | `query`: æœç´¢è¯, `top_k`: ç»“æœæ•°é‡(å¯é€‰) |

**stdio æ¨¡å¼ï¼š**

ä¹Ÿæ”¯æŒ stdio åè®®ï¼Œç”¨äº Cline/Cherry Studio ç­‰å®¢æˆ·ç«¯ï¼š

```bash
php mcp-stdio.php
```

## æŠ€æœ¯æ¶æ„

### Smart Book ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Smart Book AI Server                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   chat.html     â”‚     â”‚   HTTP Client   â”‚     â”‚ WebSocket Clientâ”‚        â”‚
â”‚  â”‚   (Web UI)      â”‚     â”‚   (curl/fetch)  â”‚     â”‚   (Browser)     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚           â”‚                       â”‚                       â”‚                  â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                   â–¼                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                        Workerman Server                              â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚    â”‚
â”‚  â”‚  â”‚   HTTP Worker       â”‚         â”‚  WebSocket Worker   â”‚            â”‚    â”‚
â”‚  â”‚  â”‚   (Port: 8088)      â”‚         â”‚   (Port: 8089)      â”‚            â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                â”‚                               â”‚                             â”‚
â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                                â–¼                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                      src/Http/Handlers.php                           â”‚    â”‚
â”‚  â”‚                    (è·¯ç”±åˆ†å‘ / è¯·æ±‚å¤„ç†)                              â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚               â”‚                                    â”‚                         â”‚
â”‚               â–¼                                    â–¼                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚     src/AI/            â”‚           â”‚    src/Cache/          â”‚            â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚            â”‚
â”‚  â”‚  â”‚  GeminiClient    â”‚  â”‚           â”‚  â”‚  CacheService    â”‚  â”‚            â”‚
â”‚  â”‚  â”‚  (åŒæ­¥ API)      â”‚  â”‚           â”‚  â”‚  (Redis ç¼“å­˜)    â”‚  â”‚            â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚            â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚            â”‚
â”‚  â”‚  â”‚ AsyncGeminiClientâ”‚  â”‚           â”‚  â”‚ RedisVectorStore â”‚  â”‚            â”‚
â”‚  â”‚  â”‚  (å¼‚æ­¥æµå¼)      â”‚  â”‚           â”‚  â”‚ (Redis 8.0 å‘é‡) â”‚  â”‚            â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚            â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚  â”‚  â”‚ AsyncCurlManager â”‚  â”‚                                                  â”‚
â”‚  â”‚  â”‚ (curl_multi)     â”‚  â”‚                                                  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                                                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                  â”‚
â”‚               â”‚                                                              â”‚
â”‚               â–¼                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                         src/RAG/                                     â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚  â”‚ EmbeddingClient  â”‚  â”‚   VectorStore    â”‚  â”‚ DocumentChunker  â”‚   â”‚    â”‚
â”‚  â”‚  â”‚ (text-embedding) â”‚  â”‚  (æ··åˆæ£€ç´¢)      â”‚  â”‚  (æ–‡æ¡£åˆ†å—)      â”‚   â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚  â”‚                   BookRAGAssistant                            â”‚   â”‚    â”‚
â”‚  â”‚  â”‚              (RAG é—®ç­”ç¼–æ’ / ä¸Šä¸‹æ–‡æ„å»º)                      â”‚   â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚    src/Parser/         â”‚           â”‚    config/prompts.php  â”‚            â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚           â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚            â”‚
â”‚  â”‚  â”‚   EpubParser     â”‚  â”‚           â”‚  â”‚  AI æç¤ºè¯é…ç½®    â”‚  â”‚            â”‚
â”‚  â”‚  â”‚  (EPUB è§£æ)     â”‚  â”‚           â”‚  â”‚ (ä¸ Python åŒæ­¥)  â”‚  â”‚            â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                   â”‚
                                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           External Services                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚   Google Gemini API â”‚         â”‚       Redis         â”‚                    â”‚
â”‚  â”‚   (LLM + Embedding) â”‚         â”‚  (ç¼“å­˜ + å‘é‡å­˜å‚¨)  â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### RAG é—®ç­”æµç¨‹

```
ç”¨æˆ·æé—® â”€â”€â–º è¯­ä¹‰ç¼“å­˜æ£€æŸ¥ â”€â”€â–º å‘½ä¸­? â”€â”€â–º è¿”å›ç¼“å­˜
                â”‚              â”‚
                â”‚ æœªå‘½ä¸­        â”‚
                â–¼              â”‚
         ç”Ÿæˆé—®é¢˜ Embedding     â”‚
                â”‚              â”‚
                â–¼              â”‚
         æ··åˆæ£€ç´¢ (å…³é”®è¯+å‘é‡)  â”‚
                â”‚              â”‚
                â–¼              â”‚
         æ„å»ºä¸Šä¸‹æ–‡ Prompt      â”‚
                â”‚              â”‚
                â–¼              â”‚
         è°ƒç”¨ Gemini API       â”‚
                â”‚              â”‚
                â–¼              â”‚
         æµå¼è¿”å› + ç¼“å­˜ç»“æœ â—„â”€â”€â”˜
```

### æ•°æ®æµå¼ä¼ è¾“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           æµå¼ä¼ è¾“æ¶æ„                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                             â”‚
â”‚  â”‚   Browser   â”‚                                                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                             â”‚
â”‚         â”‚                                                                    â”‚
â”‚         â–¼                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    SSE (Server-Sent Events)                          â”‚   â”‚
â”‚  â”‚                    POST /api/stream/ask                              â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                                    â”‚
â”‚         â”‚  HTTP Response Headers:                                            â”‚
â”‚         â”‚  Content-Type: text/event-stream                                   â”‚
â”‚         â”‚  Cache-Control: no-cache                                           â”‚
â”‚         â”‚                                                                    â”‚
â”‚         â–¼                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                      Handlers.php                                    â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  handleStreamAskAsync()                                              â”‚   â”‚
â”‚  â”‚       â”‚                                                              â”‚   â”‚
â”‚  â”‚       â”œâ”€â”€â–º sendSSE('sources', json)     // å‘é€æ£€ç´¢æ¥æº              â”‚   â”‚
â”‚  â”‚       â”‚                                                              â”‚   â”‚
â”‚  â”‚       â””â”€â”€â–º AsyncGeminiClient::chatStreamAsync()                      â”‚   â”‚
â”‚  â”‚                   â”‚                                                  â”‚   â”‚
â”‚  â”‚                   â”œâ”€â”€â–º onChunk(text) â”€â”€â–º sendSSE('content', text)    â”‚   â”‚
â”‚  â”‚                   â”‚                       // å®æ—¶å‘é€ AI è¾“å‡º        â”‚   â”‚
â”‚  â”‚                   â”‚                                                  â”‚   â”‚
â”‚  â”‚                   â””â”€â”€â–º onComplete() â”€â”€â–º sendSSE('done', '')          â”‚   â”‚
â”‚  â”‚                                          // å‘é€å®Œæˆä¿¡å·             â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                                    â”‚
â”‚         â–¼                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    AsyncCurlManager                                  â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚  â”‚  â”‚  curl_multi_init()                                              â”‚ â”‚   â”‚
â”‚  â”‚  â”‚       â”‚                                                         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚       â–¼                                                         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  Workerman Timer (10ms è½®è¯¢)                                    â”‚ â”‚   â”‚
â”‚  â”‚  â”‚       â”‚                                                         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚       â–¼                                                         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  curl_multi_exec() â”€â”€â–º CURLOPT_WRITEFUNCTION                    â”‚ â”‚   â”‚
â”‚  â”‚  â”‚       â”‚                      â”‚                                  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚       â”‚                      â–¼                                  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚       â”‚               è§£æ SSE æ•°æ®æµ                           â”‚ â”‚   â”‚
â”‚  â”‚  â”‚       â”‚               data: {"candidates":...}                  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚       â”‚                      â”‚                                  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚       â”‚                      â–¼                                  â”‚ â”‚   â”‚
â”‚  â”‚  â”‚       â”‚               onData callback â”€â”€â–º onChunk()             â”‚ â”‚   â”‚
â”‚  â”‚  â”‚       â”‚                                                         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚       â–¼                                                         â”‚ â”‚   â”‚
â”‚  â”‚  â”‚  curl_multi_info_read() â”€â”€â–º onComplete callback                 â”‚ â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                                                                    â”‚
â”‚         â–¼                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     Gemini API (streamGenerateContent)               â”‚   â”‚
â”‚  â”‚                                                                      â”‚   â”‚
â”‚  â”‚  SSE å“åº”æ ¼å¼:                                                       â”‚   â”‚
â”‚  â”‚  data: {"candidates":[{"content":{"parts":[{"text":"..."}]}}]}      â”‚   â”‚
â”‚  â”‚  data: {"candidates":[{"content":{"parts":[{"text":"..."}]}}]}      â”‚   â”‚
â”‚  â”‚  ...                                                                 â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

SSE äº‹ä»¶ç±»å‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Event        â”‚ Data                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ sources      â”‚ [{"text":"...", "score":95.2}, ...] â”‚
â”‚ cached       â”‚ {"hit":true, "similarity":98.5}     â”‚
â”‚ content      â”‚ "AI ç”Ÿæˆçš„æ–‡æœ¬ç‰‡æ®µ..."               â”‚
â”‚ done         â”‚ ""                                  â”‚
â”‚ error        â”‚ "é”™è¯¯ä¿¡æ¯"                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

WebSocket æ¶ˆæ¯ç±»å‹:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Type         â”‚ Data                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ sources      â”‚ {"type":"sources", "sources":[...]} â”‚
â”‚ content      â”‚ {"type":"content", "content":"..."}â”‚
â”‚ done         â”‚ {"type":"done"}                     â”‚
â”‚ error        â”‚ {"error":"é”™è¯¯ä¿¡æ¯"}                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## é…ç½®è¯´æ˜

### .env é…ç½®

```env
# AI API
GEMINI_API_KEY=your_api_key_here

# æœåŠ¡ç«¯å£
HTTP_PORT=8088
WS_PORT=8089

# Redis
REDIS_HOST=127.0.0.1
REDIS_PORT=6379
```

### config/app.php

```php
return [
    'server' => [
        'http_port' => getenv('HTTP_PORT') ?: 8088,
        'ws_port' => getenv('WS_PORT') ?: 8089,
    ],
    'ai' => [
        'gemini' => [
            'api_key' => getenv('GEMINI_API_KEY'),
            'model' => 'gemini-2.5-flash',
        ],
    ],
    'books' => [
        'default' => [
            'path' => '/path/to/book.epub',
            'cache' => '/path/to/index.json',
        ],
    ],
];
```

## ä¾èµ–

- PHP 8.0+
- workerman/workerman
- workerman/redis (å¼‚æ­¥ Redis)
- ext-curl
- ext-zip
- ext-mbstring

## License

MIT
