# Smart Book ğŸ“š

åŸºäº RAG (æ£€ç´¢å¢å¼ºç”Ÿæˆ) çš„ AI ä¹¦ç±åŠ©æ‰‹ï¼Œæ”¯æŒä¹¦ç±é—®ç­”ã€ç»­å†™å°è¯´ç­‰åŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹ç‚¹

- ğŸ“– **ä¹¦ç±é—®ç­”** - åŸºäº RAG æ··åˆæ£€ç´¢ï¼ˆå…³é”®è¯ + å‘é‡ï¼‰
- âœï¸ **ç»­å†™å°è¯´** - æ¨¡ä»¿åŸè‘—é£æ ¼åˆ›ä½œæ–°ç« èŠ‚
- ğŸ’¬ **é€šç”¨èŠå¤©** - Gemini AI å¯¹è¯
- ğŸŒ **Web ç•Œé¢** - Layui æš—é»‘ä¸»é¢˜èŠå¤©ç•Œé¢
- âš¡ **å®æ—¶æµå¼** - SSE æµå¼è¾“å‡º

## æ¶æ„æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Smart Book æ¶æ„                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·è¾“å…¥é—®é¢˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  chat.html  â”‚  æµè§ˆå™¨å‰ç«¯ (Layui + Marked.js)
â”‚             â”‚
â”‚  fetch()    â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
                                     â”‚ POST /api/stream/ask
                                     â–¼
                            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                            â”‚   Workerman     â”‚  HTTP Server (Port 8088)
                            â”‚                 â”‚
                            â”‚  handleStream   â”‚
                            â”‚     Ask()       â”‚
                            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                     â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                            â”‚                            â”‚
        â–¼                            â–¼                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Embedding    â”‚           â”‚ VectorStore  â”‚            â”‚ GeminiClient â”‚
â”‚ Client       â”‚           â”‚              â”‚            â”‚              â”‚
â”‚              â”‚           â”‚ hybridSearch â”‚            â”‚ chatStream() â”‚
â”‚ embedQuery() â”‚           â”‚ (å…³é”®è¯+å‘é‡) â”‚            â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                          â”‚                           â”‚
       â”‚ ç”ŸæˆæŸ¥è¯¢å‘é‡              â”‚ æ£€ç´¢ç›¸å…³æ–‡æ¡£               â”‚ æµå¼ç”Ÿæˆå›ç­”
       â–¼                          â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Gemini     â”‚           â”‚  ä¹¦ç±ç´¢å¼•     â”‚            â”‚   Gemini     â”‚
â”‚ Embedding    â”‚           â”‚  (JSONç¼“å­˜)   â”‚            â”‚   2.5 Flash  â”‚
â”‚    API       â”‚           â”‚              â”‚            â”‚     API      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                          æ•°æ®æµå¼ä¼ è¾“
                    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

  Gemini API â”€â”€(SSE)â”€â”€â–¶ curl å›è°ƒ â”€â”€(ç«‹å³)â”€â”€â–¶ sendSSE() â”€â”€(SSE)â”€â”€â–¶ æµè§ˆå™¨
      â”‚                    â”‚                      â”‚                  â”‚
      â”‚                    â”‚                      â”‚                  â”‚
   token               onChunk()           event: content      å®æ—¶æ¸²æŸ“
   by token              å›è°ƒ                data: ...         Markdown
```

## æµå¼æ•°æ®æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    SSE     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   ç«‹å³å›è°ƒ   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚    curl      â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶ â”‚   sendSSE    â”‚
â”‚  Gemini API  â”‚   token    â”‚ WRITEFUNCTIONâ”‚   onChunk   â”‚  (Workerman) â”‚
â”‚              â”‚  by token  â”‚    å›è°ƒ      â”‚             â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                                               â”‚
                                                          SSE  â”‚
                                                    event:content
                                                     data:...  â”‚
                                                               â–¼
                                                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                                       â”‚   æµè§ˆå™¨      â”‚
                                                       â”‚ ReadableStreamâ”‚
                                                       â”‚              â”‚
                                                       â”‚ å®æ—¶è§£æSSE   â”‚
                                                       â”‚ æ¸²æŸ“Markdown â”‚
                                                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ç‰¹ç‚¹**ï¼šç«¯åˆ°ç«¯æµå¼ä¼ è¾“ï¼ŒGemini æ¯ç”Ÿæˆä¸€ä¸ª token ç«‹å³ä¼ é€’åˆ°æµè§ˆå™¨æ˜¾ç¤ºï¼

## é¡¹ç›®ç»“æ„

```
smart-book/
â”œâ”€â”€ calibre_ai_prompts.php    # AI API å®¢æˆ·ç«¯ + æç¤ºè¯
â”œâ”€â”€ calibre_rag.php           # RAG å®ç°ï¼ˆæ··åˆæ£€ç´¢ï¼‰
â”œâ”€â”€ workerman_ai_server.php   # Workerman HTTP/WebSocket æœåŠ¡
â”œâ”€â”€ chat.html                 # Layui èŠå¤©ç•Œé¢
â”œâ”€â”€ continue_story.php        # ç»­å†™ç« èŠ‚è„šæœ¬
â”œâ”€â”€ test_ai.php               # AI æµ‹è¯•
â”œâ”€â”€ test_epub.php             # EPUB æµ‹è¯•
â”œâ”€â”€ test_rag.php              # RAG æµ‹è¯•
â”œâ”€â”€ test_rag2.php             # RAG æµ‹è¯•2
â””â”€â”€ debug_rag.php             # è°ƒè¯•è„šæœ¬
```

## å®‰è£…

```bash
# å®‰è£…ä¾èµ–
composer install

# æˆ–å•ç‹¬å®‰è£…
composer require workerman/workerman workerman/redis
```

## ä¾èµ–æœåŠ¡

### Redisï¼ˆå¯é€‰ï¼Œæ¨èï¼‰

Redis ç”¨äºç¼“å­˜ AI å›ç­”ï¼Œå‡å°‘é‡å¤è¯·æ±‚ï¼š

```bash
# macOS
brew install redis
brew services start redis

# éªŒè¯
redis-cli ping
# åº”è¿”å› PONG
```

å¦‚æœä¸å®‰è£… Redisï¼ŒæœåŠ¡ä¼šè‡ªåŠ¨é™çº§ä¸ºæ— ç¼“å­˜æ¨¡å¼ã€‚

## é…ç½®

åœ¨ `~/.zprofile` ä¸­è®¾ç½® Gemini API Keyï¼š

```bash
export GEMINI_API_KEY="your-api-key"
```

## ä½¿ç”¨æ–¹æ³•

### 1. å¯åŠ¨æœåŠ¡

```bash
# å‰å°è¿è¡Œ
php workerman_ai_server.php start

# å®ˆæŠ¤è¿›ç¨‹æ¨¡å¼
php workerman_ai_server.php start -d

# åœæ­¢æœåŠ¡
php workerman_ai_server.php stop

# é‡å¯æœåŠ¡
php workerman_ai_server.php restart
```

### 2. æ‰“å¼€ Web ç•Œé¢

ç›´æ¥åœ¨æµè§ˆå™¨è®¿é—®ï¼š**http://localhost:8088**

æˆ–ä½¿ç”¨å‘½ä»¤ï¼š
```bash
open http://localhost:8088
```

### 3. API æ¥å£

| ç«¯ç‚¹ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| `/api/health` | GET | å¥åº·æ£€æŸ¥ |
| `/api/ask` | POST | ä¹¦ç±é—®ç­” (RAG) |
| `/api/chat` | POST | é€šç”¨èŠå¤© |
| `/api/continue` | POST | ç»­å†™ç« èŠ‚ |

### 4. ç¤ºä¾‹è¯·æ±‚

```bash
# å¥åº·æ£€æŸ¥
curl http://localhost:8088/api/health

# ä¹¦ç±é—®ç­”
curl -X POST http://localhost:8088/api/ask \
  -H "Content-Type: application/json" \
  -d '{"question": "å­™æ‚Ÿç©ºå¤§é—¹å¤©å®«çš„ç»è¿‡"}'

# ç»­å†™ç« èŠ‚
curl -X POST http://localhost:8088/api/continue \
  -H "Content-Type: application/json" \
  -d '{"prompt": "å”åƒ§å¸ˆå¾’é‡åˆ°ç§‘æŠ€å¦–æ€ª"}'

# é€šç”¨èŠå¤©
curl -X POST http://localhost:8088/api/chat \
  -H "Content-Type: application/json" \
  -d '{"messages": [{"role": "user", "content": "ä½ å¥½"}]}'
```

### 5. å‘½ä»¤è¡Œæµ‹è¯•

```bash
# æµ‹è¯• RAG æ£€ç´¢
php test_rag2.php "å­™æ‚Ÿç©ºçš„æ­¦å™¨æ˜¯ä»€ä¹ˆ"

# ç»­å†™å°è¯´ç« èŠ‚
php continue_story.php
```

## æœåŠ¡åœ°å€

| æœåŠ¡ | åœ°å€ |
|------|------|
| HTTP API | http://localhost:8088 |
| WebSocket | ws://localhost:8081 |

## æŠ€æœ¯æ ˆ

| ç±»åˆ« | æŠ€æœ¯ | è¯´æ˜ |
|------|------|------|
| **åç«¯æ¡†æ¶** | PHP 8.0+ | é«˜æ€§èƒ½ PHP |
| **HTTP æœåŠ¡** | Workerman | å¼‚æ­¥äº‹ä»¶é©±åŠ¨æœåŠ¡å™¨ |
| **AI æ¨¡å‹** | Gemini 2.5 Flash | Google æœ€æ–°å¤§è¯­è¨€æ¨¡å‹ |
| **å‘é‡åµŒå…¥** | text-embedding-004 | Gemini æ–‡æœ¬å‘é‡åŒ– |
| **æ£€ç´¢ç­–ç•¥** | RAG æ··åˆæ£€ç´¢ | å…³é”®è¯ (60%) + å‘é‡ (40%) |
| **æµå¼ä¼ è¾“** | SSE | Server-Sent Events |
| **å‰ç«¯æ¡†æ¶** | Layui 2.9 | æš—é»‘ä¸»é¢˜ UI ç»„ä»¶ |
| **Markdown** | Marked.js | å®æ—¶æ¸²æŸ“ AI å“åº” |
| **ç¼“å­˜** | Redis + workerman/redis | å¼‚æ­¥ç¼“å­˜ AI å›ç­” |
| **æ•°æ®æ ¼å¼** | JSON | API é€šä¿¡ + ç´¢å¼•ç¼“å­˜ |

## License

MIT
