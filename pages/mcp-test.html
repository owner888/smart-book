<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MCP Client æµ‹è¯•</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #333; }
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section h2 {
            margin-top: 0;
            color: #444;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover { background: #0056b3; }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        button.danger { background: #dc3545; }
        button.danger:hover { background: #c82333; }
        button.success { background: #28a745; }
        button.success:hover { background: #218838; }
        input, select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        input[type="text"] { width: 300px; }
        pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
        }
        .status {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        .status.connected { background: #d4edda; color: #155724; }
        .status.disconnected { background: #f8d7da; color: #721c24; }
        .status.connecting { background: #fff3cd; color: #856404; }
        .log-container {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
        .log-entry { margin: 2px 0; }
        .log-entry.info { color: #6c9ef8; }
        .log-entry.error { color: #f48771; }
        .log-entry.success { color: #89d185; }
        .log-entry.notification { color: #dcdcaa; }
        .tool-card {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin: 5px 0;
        }
        .tool-card h4 { margin: 0 0 5px 0; color: #007bff; }
        .tool-card p { margin: 5px 0; color: #666; font-size: 14px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px; }
    </style>
</head>
<body>
    <h1>ğŸ”Œ MCP Client æµ‹è¯•</h1>
    
    <!-- è¿æ¥çŠ¶æ€ -->
    <div class="section">
        <h2>è¿æ¥ç®¡ç†</h2>
        <div id="status" class="status disconnected">çŠ¶æ€: æœªè¿æ¥</div>
        <div>
            <input type="text" id="serverUrl" placeholder="MCP æœåŠ¡å™¨ URL" value="http://localhost:8082/mcp">
            <button onclick="connect()" id="connectBtn">è¿æ¥</button>
            <button onclick="disconnect()" id="disconnectBtn" class="danger" disabled>æ–­å¼€</button>
            <button onclick="ping()" id="pingBtn" disabled>Ping</button>
        </div>
        <div style="margin-top: 10px;">
            <label>
                <input type="checkbox" id="debugMode" checked> è°ƒè¯•æ¨¡å¼
            </label>
        </div>
    </div>
    
    <!-- æœåŠ¡å™¨ä¿¡æ¯ -->
    <div class="section">
        <h2>æœåŠ¡å™¨ä¿¡æ¯</h2>
        <pre id="serverInfo">æœªè¿æ¥</pre>
    </div>
    
    <!-- å·¥å…·åˆ—è¡¨ -->
    <div class="section">
        <h2>å·¥å…· (Tools)</h2>
        <button onclick="listTools()" id="listToolsBtn" disabled>åˆ·æ–°å·¥å…·åˆ—è¡¨</button>
        <div id="toolsList" class="grid"></div>
    </div>
    
    <!-- è°ƒç”¨å·¥å…· -->
    <div class="section">
        <h2>è°ƒç”¨å·¥å…·</h2>
        <div>
            <select id="toolSelect">
                <option value="">-- é€‰æ‹©å·¥å…· --</option>
            </select>
        </div>
        <div id="toolParams"></div>
        <button onclick="callTool()" id="callToolBtn" disabled>è°ƒç”¨å·¥å…·</button>
        <h4>å·¥å…·è¿”å›ç»“æœ:</h4>
        <pre id="toolResult">æ— </pre>
    </div>
    
    <!-- èµ„æºåˆ—è¡¨ -->
    <div class="section">
        <h2>èµ„æº (Resources)</h2>
        <button onclick="listResources()" id="listResourcesBtn" disabled>åˆ·æ–°èµ„æºåˆ—è¡¨</button>
        <div id="resourcesList" class="grid"></div>
    </div>
    
    <!-- è¯»å–èµ„æº -->
    <div class="section">
        <h2>è¯»å–èµ„æº</h2>
        <div>
            <input type="text" id="resourceUri" placeholder="èµ„æº URI (å¦‚ book://library/list)">
            <button onclick="readResource()" id="readResourceBtn" disabled>è¯»å–</button>
        </div>
        <h4>èµ„æºå†…å®¹:</h4>
        <pre id="resourceContent">æ— </pre>
    </div>
    
    <!-- æç¤ºè¯ -->
    <div class="section">
        <h2>æç¤ºè¯ (Prompts)</h2>
        <button onclick="listPrompts()" id="listPromptsBtn" disabled>åˆ·æ–°æç¤ºè¯åˆ—è¡¨</button>
        <div id="promptsList" class="grid"></div>
    </div>
    
    <!-- æ—¥å¿— -->
    <div class="section">
        <h2>è°ƒè¯•æ—¥å¿—</h2>
        <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="logContainer" class="log-container"></div>
    </div>
    
    <script src="/static/js/mcp-client.js"></script>
    <script>
        let client = null;
        let tools = [];
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const container = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            container.appendChild(entry);
            container.scrollTop = container.scrollHeight;
        }
        
        function clearLogs() {
            document.getElementById('logContainer').innerHTML = '';
        }
        
        function updateStatus(status, message) {
            const el = document.getElementById('status');
            el.className = `status ${status}`;
            el.textContent = `çŠ¶æ€: ${message}`;
        }
        
        function setButtonsEnabled(connected) {
            document.getElementById('connectBtn').disabled = connected;
            document.getElementById('disconnectBtn').disabled = !connected;
            document.getElementById('pingBtn').disabled = !connected;
            document.getElementById('listToolsBtn').disabled = !connected;
            document.getElementById('callToolBtn').disabled = !connected;
            document.getElementById('listResourcesBtn').disabled = !connected;
            document.getElementById('readResourceBtn').disabled = !connected;
            document.getElementById('listPromptsBtn').disabled = !connected;
        }
        
        // è¿æ¥
        async function connect() {
            const url = document.getElementById('serverUrl').value;
            const debug = document.getElementById('debugMode').checked;
            
            updateStatus('connecting', 'æ­£åœ¨è¿æ¥...');
            log(`æ­£åœ¨è¿æ¥åˆ° ${url}...`);
            
            try {
                client = new McpClient(url, {
                    clientName: 'mcp-test-client',
                    clientVersion: '1.0.0',
                    debug: debug,
                });
                
                // è®¾ç½®å›è°ƒ
                client.onNotification = (data) => {
                    log(`[é€šçŸ¥] ${data.level}: ${data.message}`, 'notification');
                };
                
                client.onProgress = (data) => {
                    log(`[è¿›åº¦] ${data.token}: ${data.progress}/${data.total} - ${data.message}`, 'info');
                };
                
                client.onDisconnect = () => {
                    log('è¿æ¥å·²æ–­å¼€', 'error');
                    updateStatus('disconnected', 'å·²æ–­å¼€');
                    setButtonsEnabled(false);
                };
                
                const result = await client.connect();
                
                updateStatus('connected', 'å·²è¿æ¥');
                setButtonsEnabled(true);
                log('è¿æ¥æˆåŠŸ!', 'success');
                
                // æ˜¾ç¤ºæœåŠ¡å™¨ä¿¡æ¯
                document.getElementById('serverInfo').textContent = JSON.stringify({
                    serverInfo: client.serverInfo,
                    protocolVersion: client.protocolVersion,
                    capabilities: client.capabilities,
                }, null, 2);
                
                // è‡ªåŠ¨åŠ è½½å·¥å…·å’Œèµ„æº
                await listTools();
                await listResources();
                await listPrompts();
                
            } catch (error) {
                updateStatus('disconnected', 'è¿æ¥å¤±è´¥');
                log(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                console.error(error);
            }
        }
        
        // æ–­å¼€è¿æ¥
        async function disconnect() {
            if (client) {
                await client.disconnect();
                client = null;
            }
            updateStatus('disconnected', 'å·²æ–­å¼€');
            setButtonsEnabled(false);
            log('å·²æ–­å¼€è¿æ¥');
            
            document.getElementById('serverInfo').textContent = 'æœªè¿æ¥';
            document.getElementById('toolsList').innerHTML = '';
            document.getElementById('resourcesList').innerHTML = '';
            document.getElementById('promptsList').innerHTML = '';
        }
        
        // Ping
        async function ping() {
            try {
                log('å‘é€ ping...');
                const result = await client.ping();
                log('Pong! æœåŠ¡å™¨å“åº”æ­£å¸¸', 'success');
            } catch (error) {
                log(`Ping å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // åˆ—å‡ºå·¥å…·
        async function listTools() {
            try {
                log('è·å–å·¥å…·åˆ—è¡¨...');
                tools = await client.listTools();
                log(`è·å–åˆ° ${tools.length} ä¸ªå·¥å…·`, 'success');
                
                const container = document.getElementById('toolsList');
                const select = document.getElementById('toolSelect');
                
                container.innerHTML = '';
                select.innerHTML = '<option value="">-- é€‰æ‹©å·¥å…· --</option>';
                
                tools.forEach((tool, index) => {
                    // å·¥å…·å¡ç‰‡
                    const card = document.createElement('div');
                    card.className = 'tool-card';
                    card.innerHTML = `
                        <h4>ğŸ”§ ${tool.name}</h4>
                        <p>${tool.description || 'æ— æè¿°'}</p>
                    `;
                    container.appendChild(card);
                    
                    // ä¸‹æ‹‰é€‰é¡¹
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = tool.name;
                    select.appendChild(option);
                });
                
            } catch (error) {
                log(`è·å–å·¥å…·åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // å·¥å…·é€‰æ‹©å˜åŒ–
        document.getElementById('toolSelect').addEventListener('change', function() {
            const index = this.value;
            const paramsContainer = document.getElementById('toolParams');
            
            if (index === '') {
                paramsContainer.innerHTML = '';
                return;
            }
            
            const tool = tools[index];
            const schema = tool.inputSchema;
            
            if (!schema || !schema.properties) {
                paramsContainer.innerHTML = '<p>æ­¤å·¥å…·ä¸éœ€è¦å‚æ•°</p>';
                return;
            }
            
            let html = '<h4>å‚æ•°:</h4>';
            for (const [name, prop] of Object.entries(schema.properties)) {
                const required = schema.required?.includes(name) ? '*' : '';
                const desc = prop.description || '';
                const defaultVal = prop.default || '';
                
                html += `
                    <div style="margin-bottom: 10px;">
                        <label>${name}${required}:</label>
                        <input type="text" id="param_${name}" placeholder="${desc}" value="${defaultVal}">
                        <small style="color: #666;">${desc}</small>
                    </div>
                `;
            }
            
            paramsContainer.innerHTML = html;
        });
        
        // è°ƒç”¨å·¥å…·
        async function callTool() {
            const index = document.getElementById('toolSelect').value;
            if (index === '') {
                log('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªå·¥å…·', 'error');
                return;
            }
            
            const tool = tools[index];
            const args = {};
            
            // æ”¶é›†å‚æ•°
            if (tool.inputSchema?.properties) {
                for (const name of Object.keys(tool.inputSchema.properties)) {
                    const input = document.getElementById(`param_${name}`);
                    if (input && input.value) {
                        // å°è¯•è§£æä¸ºæ•°å­—
                        const val = input.value;
                        args[name] = isNaN(val) ? val : Number(val);
                    }
                }
            }
            
            try {
                log(`è°ƒç”¨å·¥å…· ${tool.name}ï¼Œå‚æ•°: ${JSON.stringify(args)}`);
                const result = await client.callTool(tool.name, args);
                
                const parsed = parseToolContent(result);
                document.getElementById('toolResult').textContent = 
                    typeof parsed === 'string' ? parsed : JSON.stringify(parsed, null, 2);
                
                log(`å·¥å…· ${tool.name} æ‰§è¡ŒæˆåŠŸ`, 'success');
            } catch (error) {
                document.getElementById('toolResult').textContent = `é”™è¯¯: ${error.message}`;
                log(`å·¥å…·è°ƒç”¨å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // åˆ—å‡ºèµ„æº
        async function listResources() {
            try {
                log('è·å–èµ„æºåˆ—è¡¨...');
                const resources = await client.listResources();
                log(`è·å–åˆ° ${resources.length} ä¸ªèµ„æº`, 'success');
                
                const container = document.getElementById('resourcesList');
                container.innerHTML = '';
                
                resources.forEach(resource => {
                    const card = document.createElement('div');
                    card.className = 'tool-card';
                    card.innerHTML = `
                        <h4>ğŸ“„ ${resource.name}</h4>
                        <p><strong>URI:</strong> ${resource.uri}</p>
                        <p>${resource.description || 'æ— æè¿°'}</p>
                        <button onclick="readResourceByUri('${resource.uri}')" style="margin-top: 5px;">è¯»å–</button>
                    `;
                    container.appendChild(card);
                });
                
            } catch (error) {
                log(`è·å–èµ„æºåˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // è¯»å–èµ„æº
        async function readResource() {
            const uri = document.getElementById('resourceUri').value;
            if (!uri) {
                log('è¯·è¾“å…¥èµ„æº URI', 'error');
                return;
            }
            await readResourceByUri(uri);
        }
        
        async function readResourceByUri(uri) {
            try {
                log(`è¯»å–èµ„æº: ${uri}`);
                const result = await client.readResource(uri);
                
                const parsed = parseResourceContent(result);
                document.getElementById('resourceContent').textContent = 
                    typeof parsed === 'string' ? parsed : JSON.stringify(parsed, null, 2);
                
                document.getElementById('resourceUri').value = uri;
                log(`èµ„æºè¯»å–æˆåŠŸ`, 'success');
            } catch (error) {
                document.getElementById('resourceContent').textContent = `é”™è¯¯: ${error.message}`;
                log(`èµ„æºè¯»å–å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // åˆ—å‡ºæç¤ºè¯
        async function listPrompts() {
            try {
                log('è·å–æç¤ºè¯åˆ—è¡¨...');
                const prompts = await client.listPrompts();
                log(`è·å–åˆ° ${prompts.length} ä¸ªæç¤ºè¯`, 'success');
                
                const container = document.getElementById('promptsList');
                container.innerHTML = '';
                
                prompts.forEach(prompt => {
                    const card = document.createElement('div');
                    card.className = 'tool-card';
                    card.innerHTML = `
                        <h4>ğŸ’¬ ${prompt.name}</h4>
                        <p><strong>æ ‡é¢˜:</strong> ${prompt.title || prompt.name}</p>
                        <p>${prompt.description || 'æ— æè¿°'}</p>
                        ${prompt.arguments ? `<p><strong>å‚æ•°:</strong> ${prompt.arguments.map(a => a.name).join(', ')}</p>` : ''}
                    `;
                    container.appendChild(card);
                });
                
            } catch (error) {
                log(`è·å–æç¤ºè¯åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆ
        log('MCP Client æµ‹è¯•é¡µé¢å·²åŠ è½½');
        log('è¯·ç‚¹å‡»"è¿æ¥"æŒ‰é’®è¿æ¥åˆ° MCP æœåŠ¡å™¨');
    </script>
</body>
</html>
